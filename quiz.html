<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± - Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</title>
  
  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #5dade2;
      --accent-color: #85c1e9;
      --success-color: #2ecc71;
      --error-color: #e74c3c;
      --warning-color: #f39c12;
      --dark-color: #2c3e50;
      --light-color: #ecf0f1;
    }
    
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .quiz-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .quiz-header {
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      color: white;
      padding: 2rem;
      text-align: center;
    }
    
    .question-image {
      width: 100%;
      max-height: 300px;
      object-fit: contain;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      display: none;
    }
    
    .question-text {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 2rem;
      line-height: 1.6;
      color: var(--dark-color);
    }
    
    .options-container {
      margin: 2rem 0;
    }
    
    .option-item {
      padding: 1.2rem 1.5rem;
      margin-bottom: 1rem;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .option-item:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.1);
    }
    
    .option-item.selected {
      border-color: var(--primary-color);
      background: rgba(52, 152, 219, 0.05);
    }
    
    .option-item.correct {
      border-color: var(--success-color);
      background: rgba(46, 204, 113, 0.1);
    }
    
    .option-item.incorrect {
      border-color: var(--error-color);
      background: rgba(231, 76, 60, 0.1);
    }
    
    .option-item.missed-correct {
      border-color: var(--success-color);
      background: rgba(46, 204, 113, 0.05);
      border-style: dashed;
    }
    
    .option-number {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: #f8f9fa;
      border: 2px solid #dee2e6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .option-item.selected .option-number {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }
    
    .option-item.correct .option-number {
      background: var(--success-color);
      border-color: var(--success-color);
      color: white;
    }
    
    .option-item.incorrect .option-number {
      background: var(--error-color);
      border-color: var(--error-color);
      color: white;
    }
    
    .option-text {
      flex: 1;
      font-size: 1.1rem;
    }
    
    .quiz-footer {
      padding: 2rem;
      background: #f8f9fa;
      border-top: 1px solid #e9ecef;
    }
    
    .progress-container {
      margin-bottom: 2rem;
    }
    
    .progress-text {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    
    .progress-bar {
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    .navigation-buttons {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      border: none;
      padding: 12px 30px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .result-container {
      text-align: center;
      padding: 3rem 2rem;
      display: none;
    }
    
    .score-circle {
      width: 200px;
      height: 200px;
      margin: 0 auto 2rem;
      position: relative;
    }
    
    .circle-bg {
      fill: none;
      stroke: #e9ecef;
      stroke-width: 8;
    }
    
    .circle-progress {
      fill: none;
      stroke: var(--success-color);
      stroke-width: 8;
      stroke-linecap: round;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
      transition: stroke-dasharray 1s ease;
    }
    
    .score-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    
    .score-percentage {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--success-color);
      display: block;
    }
    
    .score-fraction {
      font-size: 1.2rem;
      color: #666;
      display: block;
    }
    
    .result-actions {
      margin-top: 2rem;
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
    
    .details-container {
      display: none;
      margin-top: 2rem;
    }
    
    .question-review {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid #e9ecef;
    }
    
    .explanation {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      border-right: 4px solid var(--success-color);
    }
    
    .alert {
      border: none;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 1rem;
    }
    
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 3rem;
    }
    
    .question-counter {
      background: rgba(255,255,255,0.2);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 600;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .quiz-header {
        padding: 1.5rem 1rem;
      }
      
      .question-text {
        font-size: 1.1rem;
      }
      
      .option-item {
        padding: 1rem;
      }
      
      .navigation-buttons {
        flex-direction: column;
      }
      
      .score-circle {
        width: 150px;
        height: 150px;
      }
      
      .score-percentage {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>

  <div class="quiz-container">
    <!-- Ø±Ø£Ø³ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± -->
    <div class="quiz-header">
      <h2 id="quizTitle">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„</h2>
      <div class="question-counter" id="questionCounter">Ø³Ø¤Ø§Ù„ 1 Ù…Ù† 10</div>
    </div>

    <!-- Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
    <div id="alertsContainer" aria-live="polite" aria-atomic="true"></div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
    <div class="container py-4" id="questionsArea">
      <!-- ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ -->
      <img id="questionImage" class="question-image" alt="ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„">
      
      <!-- Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ -->
      <div class="question-text" id="questionText">
        Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„...
      </div>
      
      <!-- Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª -->
      <div class="options-container" id="optionsContainer">
        <div class="loading-spinner">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
          </div>
        </div>
      </div>
      
      <!-- ØªÙ‚Ø¯Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± -->
      <div class="progress-container">
        <div class="progress-text">
          <span>ØªÙ‚Ø¯Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</span>
          <span id="progressText">0%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
      </div>
      
      <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ -->
      <div class="navigation-buttons">
        <button class="btn btn-outline-primary" id="prevBtn" disabled>
          <i class="bi bi-arrow-right me-2"></i>Ø§Ù„Ø³Ø§Ø¨Ù‚
        </button>
        <button class="btn btn-primary" id="nextBtn">
          Ø§Ù„ØªØ§Ù„ÙŠ<i class="bi bi-arrow-left ms-2"></i>
        </button>
        <button class="btn btn-success" id="submitBtn" style="display: none;">
          <i class="bi bi-send me-2"></i>ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
        </button>
      </div>
    </div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
    <div class="result-container" id="resultContainer">
      <h3>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
      <p class="text-muted mb-4">Ø£Ø­Ø³Ù†Øª! Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­</p>
      
      <div class="score-circle">
        <svg viewBox="0 0 100 100">
          <circle class="circle-bg" cx="50" cy="50" r="45"></circle>
          <circle class="circle-progress" cx="50" cy="50" r="45" id="scoreCircle"></circle>
        </svg>
        <div class="score-text">
          <span class="score-percentage" id="scorePercentage">0%</span>
          <span class="score-fraction" id="scoreFraction">0/0</span>
        </div>
      </div>
      
      <div class="result-actions">
        <button class="btn btn-outline-primary" id="reviewBtn">
          <i class="bi bi-eye me-2"></i>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
        </button>
        <button class="btn btn-primary" id="retryBtn">
          <i class="bi bi-arrow-repeat me-2"></i>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
        </button>
      </div>
    </div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
    <div class="details-container" id="detailsContainer">
      <div class="container py-4">
        <h4 class="mb-4">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</h4>
        <div id="questionsReview">
          <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‡Ù†Ø§ -->
        </div>
        <div class="text-center mt-4">
          <button class="btn btn-primary" onclick="quizSystem.hideDetails()">
            <i class="bi bi-arrow-up me-2"></i>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù†ØªÙŠØ¬Ø©
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù…Ø¹ Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    class AdvancedQuizSystem {
      constructor() {
        this.questions = [];
        this.currentQuestionIndex = 0;
        this.userAnswers = {};
        this.quizResults = null;
        this.quizId = this.getQuizIdFromURL(); // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
        this.init();
      }

      init() {
        this.setupEventListeners();
        this.loadQuizData();
      }

      getQuizIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('quiz_id') || 1; // Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
      }

      setupEventListeners() {
        document.getElementById('prevBtn').addEventListener('click', () => this.previousQuestion());
        document.getElementById('nextBtn').addEventListener('click', () => this.nextQuestion());
        document.getElementById('submitBtn').addEventListener('click', () => this.submitQuiz());
        document.getElementById('reviewBtn').addEventListener('click', () => this.showDetails());
        document.getElementById('retryBtn').addEventListener('click', () => this.retryQuiz());
      }

      async loadQuizData() {
        try {
          this.showLoading();
          
          // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          const response = await fetch(`/api/quizzes/${this.quizId}/questions`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${this.getToken()}`
            }
          });

          if (!response.ok) {
            throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±');
          }

          const data = await response.json();
          
          if (data.success && data.questions) {
            this.questions = data.questions;
            this.displayQuestion(0);
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
            if (data.quiz_title) {
              document.getElementById('quizTitle').textContent = data.quiz_title;
            }
          } else {
            throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
          }

        } catch (error) {
          console.error('Error loading quiz data:', error);
          this.showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'danger');
          
          // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„
          this.loadSampleData();
        }
      }

      loadSampleData() {
        // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ù„Ù„Ø·ÙˆØ§Ø±Ø¦ ÙÙ‚Ø·)
        this.questions = [
          {
            id: 1,
            text: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©ØŸ",
            image: null,
            options: [
              { id: 1, text: "Ø¬Ø¯Ø©" },
              { id: 2, text: "Ø§Ù„Ø±ÙŠØ§Ø¶" },
              { id: 3, text: "Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©" },
              { id: 4, text: "Ø§Ù„Ø¯Ù…Ø§Ù…" }
            ],
            correct_answer: 2,
            explanation: "Ø§Ù„Ø±ÙŠØ§Ø¶ Ù‡ÙŠ Ø§Ù„Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ø³ÙŠØ§Ø³ÙŠØ© ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ù„Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© ÙˆØªÙ‚Ø¹ ÙÙŠ ÙˆØ³Ø· Ø´Ø¨Ù‡ Ø§Ù„Ø¬Ø²ÙŠØ±Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©."
          }
        ];
        this.displayQuestion(0);
      }

      displayQuestion(index) {
        if (index < 0 || index >= this.questions.length) return;

        this.currentQuestionIndex = index;
        const question = this.questions[index];

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
        document.getElementById('questionCounter').textContent = 
          `Ø³Ø¤Ø§Ù„ ${index + 1} Ù…Ù† ${this.questions.length}`;

        // Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¥Ù† ÙˆØ¬Ø¯Øª
        const questionImage = document.getElementById('questionImage');
        if (question.image) {
          questionImage.src = question.image;
          questionImage.style.display = 'block';
          questionImage.onerror = () => {
            questionImage.style.display = 'none';
          };
        } else {
          questionImage.style.display = 'none';
        }

        // Ø¹Ø±Ø¶ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„
        document.getElementById('questionText').textContent = question.text;

        // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª
        this.displayOptions(question);

        // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„
        this.updateNavigationButtons();

        // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
        this.updateProgress();

        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
        this.restoreUserAnswer();
      }

      displayOptions(question) {
        const optionsContainer = document.getElementById('optionsContainer');
        const optionLetters = ['Ø£', 'Ø¨', 'Ø¬', 'Ø¯'];

        optionsContainer.innerHTML = question.options.map((option, index) => `
          <div class="option-item" data-option-id="${option.id}" onclick="quizSystem.selectOption(${option.id})">
            <div class="option-number">${optionLetters[index]}</div>
            <div class="option-text">${this.sanitizeHTML(option.text)}</div>
          </div>
        `).join('');
      }

      selectOption(optionId) {
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
        document.querySelectorAll('.option-item').forEach(item => {
          item.classList.remove('selected');
        });

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
        const selectedOption = document.querySelector(`[data-option-id="${optionId}"]`);
        if (selectedOption) {
          selectedOption.classList.add('selected');
        }

        // Ø­ÙØ¸ Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        this.userAnswers[this.currentQuestionIndex] = optionId;

        // ØªÙ…ÙƒÙŠÙ† Ø²Ø± Ø§Ù„ØªØ§Ù„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¥Ø¬Ø§Ø¨Ø©
        document.getElementById('nextBtn').disabled = false;
      }

      restoreUserAnswer() {
        const userAnswer = this.userAnswers[this.currentQuestionIndex];
        if (userAnswer) {
          const selectedOption = document.querySelector(`[data-option-id="${userAnswer}"]`);
          if (selectedOption) {
            selectedOption.classList.add('selected');
          }
        }
      }

      previousQuestion() {
        if (this.currentQuestionIndex > 0) {
          this.displayQuestion(this.currentQuestionIndex - 1);
        }
      }

      nextQuestion() {
        if (this.currentQuestionIndex < this.questions.length - 1) {
          this.displayQuestion(this.currentQuestionIndex + 1);
        } else {
          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ø¢Ø®Ø± Ø³Ø¤Ø§Ù„ØŒ Ø¹Ø±Ø¶ Ø²Ø± Ø§Ù„ØªØ³Ù„ÙŠÙ…
          this.showSubmitButton();
        }
      }

      showSubmitButton() {
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('submitBtn').style.display = 'block';
      }

      updateNavigationButtons() {
        document.getElementById('prevBtn').disabled = this.currentQuestionIndex === 0;
        
        const hasAnswer = this.userAnswers[this.currentQuestionIndex] !== undefined;
        document.getElementById('nextBtn').disabled = !hasAnswer && this.currentQuestionIndex < this.questions.length - 1;
      }

      updateProgress() {
        const progress = ((this.currentQuestionIndex + 1) / this.questions.length) * 100;
        document.getElementById('progressFill').style.width = `${progress}%`;
        document.getElementById('progressText').textContent = `${Math.round(progress)}%`;
      }

      async submitQuiz() {
        try {
          this.showLoading();
          
          // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©
          this.calculateResults();
          
          // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
          this.showResults();
          
          // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø®Ø§Ø¯Ù… ÙˆØ­ÙØ¸Ù‡Ø§ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          await this.saveResultsToDatabase();
          
        } catch (error) {
          console.error('Error submitting quiz:', error);
          this.showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª', 'danger');
        }
      }

      calculateResults() {
        let correctAnswers = 0;
        const results = [];

        this.questions.forEach((question, index) => {
          const userAnswer = this.userAnswers[index];
          const isCorrect = userAnswer === question.correct_answer;
          
          if (isCorrect) {
            correctAnswers++;
          }

          results.push({
            question: question,
            userAnswer: userAnswer,
            isCorrect: isCorrect,
            correctAnswer: question.correct_answer
          });
        });

        this.quizResults = {
          totalQuestions: this.questions.length,
          correctAnswers: correctAnswers,
          score: (correctAnswers / this.questions.length) * 100,
          details: results,
          quizId: this.quizId,
          timestamp: new Date().toISOString()
        };
      }

      showResults() {
        // Ø¥Ø®ÙØ§Ø¡ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        document.getElementById('questionsArea').style.display = 'none';
        
        // Ø¹Ø±Ø¶ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        document.getElementById('resultContainer').style.display = 'block';

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªÙŠØ¬Ø©
        const score = Math.round(this.quizResults.score);
        document.getElementById('scorePercentage').textContent = `${score}%`;
        document.getElementById('scoreFraction').textContent = 
          `${this.quizResults.correctAnswers}/${this.quizResults.totalQuestions}`;

        // ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©
        this.animateScoreCircle(score);
        
        this.showAlert(`ğŸ‰ Ø£Ø­Ø³Ù†Øª! Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ${this.quizResults.correctAnswers} Ù…Ù† ${this.quizResults.totalQuestions}`, 'success');
      }

      animateScoreCircle(score) {
        const circle = document.getElementById('scoreCircle');
        const radius = 45;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (score / 100) * circumference;

        circle.style.strokeDasharray = `${circumference} ${circumference}`;
        circle.style.strokeDashoffset = circumference;

        // Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
        setTimeout(() => {
          circle.style.strokeDashoffset = offset;
        }, 100);
      }

      async saveResultsToDatabase() {
        try {
          const response = await fetch('/api/quiz/results', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${this.getToken()}`
            },
            body: JSON.stringify({
              quiz_id: this.quizResults.quizId,
              score: this.quizResults.score,
              correct_answers: this.quizResults.correctAnswers,
              total_questions: this.quizResults.totalQuestions,
              user_answers: this.userAnswers,
              time_spent: this.calculateTimeSpent(),
              completed_at: this.quizResults.timestamp
            })
          });

          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
              this.showAlert('âœ… ØªÙ… Ø­ÙØ¸ Ù†ØªÙŠØ¬ØªÙƒ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
            } else {
              throw new Error(result.message || 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©');
            }
          } else {
            throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
          }
        } catch (error) {
          console.error('Error saving results:', error);
          this.showAlert('âš ï¸ ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙˆÙ„ÙƒÙ† Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸Ù‡Ø§ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'warning');
        }
      }

      calculateTimeSpent() {
        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚ Ù‡Ù†Ø§
        return Math.floor(Math.random() * 600) + 300; // ÙˆÙ‚Øª Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù„Ø¹Ø±Ø¶
      }

      showDetails() {
        document.getElementById('resultContainer').style.display = 'none';
        document.getElementById('detailsContainer').style.display = 'block';
        this.displayQuestionsReview();
      }

      hideDetails() {
        document.getElementById('detailsContainer').style.display = 'none';
        document.getElementById('resultContainer').style.display = 'block';
      }

      displayQuestionsReview() {
        const reviewContainer = document.getElementById('questionsReview');
        const optionLetters = ['Ø£', 'Ø¨', 'Ø¬', 'Ø¯'];

        reviewContainer.innerHTML = this.quizResults.details.map((result, index) => {
          const question = result.question;
          const userAnswerText = this.getOptionText(question, result.userAnswer);
          const correctAnswerText = this.getOptionText(question, result.correctAnswer);
          
          return `
            <div class="question-review">
              <h6>Ø³Ø¤Ø§Ù„ ${index + 1}: ${this.sanitizeHTML(question.text)}</h6>
              
              ${question.image ? `
                <img src="${question.image}" class="question-image mt-2" style="display: block; max-height: 200px;">
              ` : ''}
              
              <div class="options-container mt-3">
                ${question.options.map((option, optIndex) => {
                  let className = '';
                  if (option.id === result.correctAnswer) {
                    className = 'correct';
                  } else if (option.id === result.userAnswer && !result.isCorrect) {
                    className = 'incorrect';
                  } else if (option.id === result.correctAnswer && option.id !== result.userAnswer) {
                    className = 'missed-correct';
                  }

                  return `
                    <div class="option-item ${className}">
                      <div class="option-number">${optionLetters[optIndex]}</div>
                      <div class="option-text">${this.sanitizeHTML(option.text)}</div>
                    </div>
                  `;
                }).join('')}
              </div>

              ${question.explanation ? `
                <div class="explanation">
                  <strong>ğŸ“ Ø´Ø±Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</strong>
                  <p class="mb-0 mt-2">${this.sanitizeHTML(question.explanation)}</p>
                </div>
              ` : ''}

              <div class="mt-3 p-3 rounded ${result.isCorrect ? 'bg-success text-white' : 'bg-danger text-white'}">
                <strong>${result.isCorrect ? 'âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©' : 'âŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©'}</strong>
                ${!result.isCorrect ? `
                  <div class="mt-2">
                    <span>Ø¥Ø¬Ø§Ø¨ØªÙƒ: ${userAnswerText || 'Ù„Ù… ØªØ¬Ø¨'}</span><br>
                    <span>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${correctAnswerText}</span>
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }).join('');
      }

      getOptionText(question, optionId) {
        const option = question.options.find(opt => opt.id === optionId);
        return option ? option.text : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±';
      }

      retryQuiz() {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        this.userAnswers = {};
        this.quizResults = null;
        this.currentQuestionIndex = 0;

        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶
        document.getElementById('resultContainer').style.display = 'none';
        document.getElementById('questionsArea').style.display = 'block';
        document.getElementById('nextBtn').style.display = 'block';
        document.getElementById('submitBtn').style.display = 'none';

        this.displayQuestion(0);
        this.showAlert('ğŸ”„ ØªÙ… Ø¨Ø¯Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©', 'info');
      }

      getToken() {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ token Ù…Ù† localStorage Ø£Ùˆ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
        return localStorage.getItem('token') || sessionStorage.getItem('token') || '';
      }

      showLoading() {
        const optionsContainer = document.getElementById('optionsContainer');
        optionsContainer.innerHTML = `
          <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
            </div>
          </div>
        `;
      }

      showAlert(message, type = 'info') {
        const alertsContainer = document.getElementById('alertsContainer');
        const alertId = 'alert-' + Date.now();
        
        const div = document.createElement('div');
        div.id = alertId;
        div.className = `alert alert-${type} alert-dismissible fade show`;
        div.setAttribute('role', 'alert');
        div.textContent = message;
        
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn-close';
        btn.setAttribute('data-bs-dismiss', 'alert');
        btn.setAttribute('aria-label', 'Ø¥ØºÙ„Ø§Ù‚');
        
        div.appendChild(btn);
        alertsContainer.innerHTML = '';
        alertsContainer.appendChild(div);
        
        setTimeout(() => {
          const alertElement = document.getElementById(alertId);
          if (alertElement) {
            alertElement.remove();
          }
        }, 5000);
      }

      sanitizeHTML(str) {
        if (!str) return '';
        const temp = document.createElement('div');
        temp.textContent = str;
        return temp.innerHTML;
      }
    }

    // ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    const quizSystem = new AdvancedQuizSystem();

    // Ø¥Ø¶Ø§ÙØ© Ø¨Ø¹Ø¶ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
    document.addEventListener('DOMContentLoaded', function() {
      // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ±Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ±
      const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.style.opacity = '1';
            entry.target.style.transform = 'translateY(0)';
          }
        });
      }, observerOptions);

      // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      document.querySelectorAll('.option-item, .question-review').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        el.style.transition = 'all 0.5s ease';
        observer.observe(el);
      });
    });
  </script>
</body>
</html>
